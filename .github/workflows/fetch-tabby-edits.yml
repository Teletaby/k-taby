name: Auto-fetch tabby_edits

on:
  schedule:
    # Runs at 07:00 UTC which is 15:00 Philippine Time (UTC+8)
    - cron: '0 7 * * *'
  workflow_dispatch: {}

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Call deployed site fetch endpoint (if configured)
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
          ADMIN_TOKEN: ${{ secrets.TABBY_ADMIN_TOKEN }}
        run: |
          if [ -z "$SITE_URL" ] || [ -z "$ADMIN_TOKEN" ]; then
            echo "SITE_URL or TABBY_ADMIN_TOKEN not set in secrets â€” skipping remote fetch."
            echo "If you want remote auto-fetch, set SITE_URL to your deployed site URL and TABBY_ADMIN_TOKEN to a secret token."
            exit 0
          fi

          echo "Calling $SITE_URL/api/tabby_edits/fetch?user=tabby_edits"
          HTTP_STATUS=$(curl -s -o /tmp/resp.json -w "%{http_code}" -H "x-admin-token: $ADMIN_TOKEN" "$SITE_URL/api/tabby_edits/fetch?user=tabby_edits") || true
          echo "status: $HTTP_STATUS"
          cat /tmp/resp.json || true

      - name: Fallback: run local fetch script (no commit)
        if: ${{ always() }}
        env:
          ALLOW_HEADLESS: 'true'
        run: |
          echo "Running local fetch script as fallback with headless enabled (does not commit to repo)."
          npm ci --silent
          node scripts/fetch_tabby_edits.js || true
          echo "Local fetch complete. To persist data to repo, run the previous workflow variant."
